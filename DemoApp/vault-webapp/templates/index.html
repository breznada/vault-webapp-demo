<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HashiCorp Vault Demo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f8f9fa;
      color: #000;
      font-family: system-ui, sans-serif;
    }

    .vault-logo {
      font-size: 1.5rem;
      font-weight: bold;
      letter-spacing: 1px;
      color: #000;
    }

    .card {
      border: 1px solid #ccc;
      border-radius: 12px;
    }

    .btn-custom {
      background-color: #000;
      color: #fff;
      border: 1px solid #000;
    }

    .btn-custom:hover {
      background-color: #fff;
      color: #000;
      border: 1px solid #000;
    }

    .message-box {
      border-radius: 6px;
      margin-top: 10px;
      padding: 12px 16px;
      position: relative;
      font-size: 0.95rem;
    }

    .message-box.success {
      background-color: #d1e7dd;
      border: 1px solid #198754;
      color: #0f5132;
    }

    .message-box.error {
      background-color: #f8d7da;
      border: 1px solid #dc3545;
      color: #842029;
    }

    .close-btn {
      position: absolute;
      top: 8px;
      right: 12px;
      font-size: 1.2rem;
      cursor: pointer;
      color: #555;
    }

    .close-btn:hover {
      color: #000;
    }

    .footer-note {
      text-align: center;
      font-size: 0.85rem;
      color: #555;
      margin-top: 40px;
    }
  </style>
  <script>
    function closeMessage(btn) {
      btn.parentElement.style.display = 'none';
    }
  </script>
</head>
<body>
  <div class="container py-5">
    <div class="text-center mb-4">
      <div class="vault-logo">üîê HashiCorp Vault Demo</div>
      <p class="text-muted">Secure database access and encryption</p>
    </div>

    <!-- Side-by-side Cards -->
    <div class="row justify-content-center mb-4">
      <!-- Database Connection -->
      <div class="col-md-6">
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h5 class="mb-4 text-center">üíæÔ∏è Vault Database Connection Demo</h5>
            <form method="post">
              <div class="mb-3">
                <label class="form-label">Static Credentials (No Vault)</label>
                <button name="connect_env" type="submit" class="btn btn-custom w-100">Connect using .env file</button>
                {% if message and clicked_button == 'connect_env' %}
                  <div class="message-box {{ 'success' if success else 'error' }}">
                    <span class="close-btn" onclick="closeMessage(this)">&times;</span>
                    {{ message|safe }}
                  </div>
                {% endif %}
              </div>

              <div class="mb-3">
                <label class="form-label">Static Credentials (From Vault)</label>
                <button name="connect_vault" type="submit" class="btn btn-custom w-100">Connect using .env with Vault-injected values</button>
                {% if message and clicked_button == 'connect_vault' %}
                  <div class="message-box {{ 'success' if success else 'error' }}">
                    <span class="close-btn" onclick="closeMessage(this)">&times;</span>
                    {{ message|safe }}
                  </div>
                {% endif %}
              </div>

              <div class="mb-3">
                <label class="form-label">Dynamic Credentials (Live from Vault)</label>
                <button name="connect_dynamic" type="submit" class="btn btn-custom w-100">Connect using dynamic credentials</button>
                {% if message and clicked_button == 'connect_dynamic' %}
                  <div class="message-box {{ 'success' if success else 'error' }}">
                    <span class="close-btn" onclick="closeMessage(this)">&times;</span>
                    {{ message|safe }}
                    {% if lease_expiry %}
                      <div id="lease-timer" style="margin-top:10px; font-weight: bold;"></div>
                      <script>
                        const expiryTime = new Date("{{ lease_expiry.isoformat() }}Z").getTime();
                        const timerEl = document.getElementById('lease-timer');
                        function updateTimer() {
                          const now = new Date().getTime();
                          let diff = Math.floor((expiryTime - now) / 1000);
                          if (diff < 0) {
                            timerEl.innerText = 'Credentials expired.';
                            clearInterval(timerInterval);
                            return;
                          }
                          const mins = Math.floor(diff / 60);
                          const secs = diff % 60;
                          timerEl.innerText = `Credentials expire in ${mins}:${secs.toString().padStart(2, '0')} minutes`;
                        }
                        updateTimer();
                        const timerInterval = setInterval(updateTimer, 1000);
                      </script>
                    {% endif %}
                  </div>
                {% endif %}
              </div>

              <div class="mb-3">
                <label class="form-label">Stored Dynamic Credentials</label>
                <button name="reconnect_cached" type="submit" class="btn btn-custom w-100">Connect using stored credentials</button>
                {% if message and clicked_button == 'reconnect_cached' %}
                  <div class="message-box {{ 'success' if success else 'error' }}">
                    <span class="close-btn" onclick="closeMessage(this)">&times;</span>
                    {{ message|safe }}
                  </div>
                {% endif %}
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Transit Encryption -->
      <div class="col-md-6">
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h5 class="mb-4 text-center">üîë Vault Transit Encryption Demo</h5>
            <form method="post">
              <div class="mb-3">
                <label for="plaintext_input" class="form-label">Text to Encrypt</label>
                <input type="text" class="form-control" id="plaintext_input" name="plaintext_input" placeholder="Enter text to encrypt">
              </div>
              <button type="submit" name="encrypt_text" class="btn btn-custom w-100">Encrypt</button>
            </form>

            <form method="post" class="mt-4">
              <div class="mb-3">
                <label for="ciphertext_input" class="form-label">Ciphertext to Decrypt</label>
                <input type="text" class="form-control" id="ciphertext_input" name="ciphertext_input" placeholder="Enter Vault ciphertext">
              </div>
              <button type="submit" name="decrypt_text" class="btn btn-custom w-100">Decrypt</button>
            </form>

            {% if message and (clicked_button == 'encrypt_text' or clicked_button == 'decrypt_text') %}
              <div class="message-box {{ 'success' if success else 'error' }}">
                <span class="close-btn" onclick="closeMessage(this)">&times;</span>
                {{ message|safe }}
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- PKI Certificate Generation -->
    <div class="row justify-content-center">
      <div class="col-md-12">
        <div class="card shadow-sm mb-5">
          <div class="card-body">
            <h5 class="mb-4 text-center">üìÑ Vault PKI Certificate Demo</h5>
            <form method="post">
              <div class="mb-3">
                <label for="common_name" class="form-label">Common Name (CN)</label>
                <input type="text" class="form-control" id="common_name" name="common_name" placeholder="e.g., demo.tec.cz.ibm.com">
              </div>
              <button type="submit" name="generate_cert" class="btn btn-custom w-100">Generate Certificate</button>
            </form>

            {% if message and clicked_button == 'generate_cert' %}
              <div class="message-box {{ 'success' if success else 'error' }}">
                <span class="close-btn" onclick="closeMessage(this)">&times;</span>
                {{ message|safe }}
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer-note">
      Powered by <strong>HashiCorp Vault</strong><br />
      ¬©Adam Breznen, IBM.
    </div>
  </div>
</body>
</html>
